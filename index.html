<!DOCTYPE html>
<html>
<meta charset="UTF-8">
<script src="phaser.min.js"></script>
<script
<script language="javascript">

var game = new Phaser.Game(800, 600, Phaser.AUTO, 'MasterChef v1', { preload: preload, create: create, render:render });

var sprites;

var objets = {
	lait: {
		nom: 'lait',
		type: 'ingrédient',
		états: ['plein','entamé','presqueVide','vide'],
		état: 'plein',
		x: 280,
		y: 420,
		mobile: true
	},
	farine: {
		nom: 'farine',
		type: 'ingrédient',
		états: ['neuf','entamé'],
		état: 'neuf',
		x: 210,
		y: 420,
		mobile: true
	},
	saladier: {
		nom: 'saladier',
		type: 'ustensile',
		états: ['propre', 'mélangé', 'sale', 'blanc', 'oeuf', 'épice', 'presqueTout', 'tout'],
		état: 'propre',
		contenu: [],
		x: 400,
		y: 410,
		mobile: false
	},
	sucre: {
		nom: 'sucre',
		type: 'ingrédient',
		états: ['plein'],
		état: 'plein',
		x: 120,
		y: 420,
		mobile: true
	},
	doseur: {
		nom: 'doseur',
		type: 'conteneur',
		états: ['vide', 'plein'],
		état: 'vide',
		contenu: [],
		x: 510,
		y: 450,
		mobile: true
	},
}

var interactions = {
	'lait/plein': {
		'doseur/vide': function(lait, doseur) {
			lait.état='entamé'; lait.sprite.frame=1;
			doseur.état='plein'; doseur.sprite.frame=1;
			doseur.contenu.push('laitMesuré');
		},
		'saladier/propre': function(lait, saladier) {
			lait.état='entamé'; lait.sprite.frame=1;
			saladier.état='blanc'; saladier.sprite.frame=3;
			saladier.contenu.push('lait')
		},
		'saladier/blanc': function(lait, saladier) {
			lait.état='entamé'; lait.sprite.frame=1;
			saladier.contenu.push('lait')
		}
	},
	'lait/entamé': {
		'doseur/vide': function(lait, doseur) {
			lait.état='presqueVide'; lait.sprite.frame=2;
			doseur.état='plein'; doseur.sprite.frame=1;
			doseur.contenu.push('laitMesuré');
		},
		'saladier/propre': function(lait, saladier) {
			lait.état='presqueVide'; lait.sprite.frame=2;
			saladier.état='blanc'; saladier.sprite.frame=3;
			saladier.contenu.push('lait')
		},
		'saladier/blanc': function(lait, saladier) {
			lait.état='presqueVide'; lait.sprite.frame=2;
			saladier.contenu.push('lait')
		}
	},
	'lait/presqueVide': {
		'doseur/vide': function(lait, doseur) {
			lait.état='vide'; lait.sprite.frame=3;
			doseur.état='plein'; doseur.sprite.frame=1;
			doseur.contenu.push('laitMesuré');
		},
		'saladier/propre': function(lait, saladier) {
			lait.état='vide'; lait.sprite.frame=3;
			saladier.état='blanc'; saladier.sprite.frame=3;
			saladier.contenu.push('lait')
		},
		'saladier/blanc': function(lait, saladier) {
			lait.état='vide'; lait.sprite.frame=3;
			saladier.contenu.push('lait')
		}
	},
	'farine/neuf': {
		'doseur/vide': function(farine, doseur) {
			farine.état='entamé'; farine.sprite.frame=1;
			doseur.état='plein'; doseur.sprite.frame=1;
			doseur.contenu.push('farineMesurée');
		},
		'saladier/propre': function(farine, saladier) {
			farine.état='entamé'; farine.sprite.frame=1;
			saladier.état='blanc'; saladier.sprite.frame=3;
			saladier.contenu.push('farine')
		},
		'saladier/blanc': function(farine, saladier) {
			farine.état='entamé'; farine.sprite.frame=1;
			saladier.contenu.push('farine')
		}
	},
	'farine/entamé': {
		'doseur/vide': function(farine, doseur) {
			doseur.état='plein'; doseur.sprite.frame=1;
			doseur.contenu.push('farineMesurée');
		},
		'saladier/propre': function(farine, saladier) {
			saladier.état='blanc'; saladier.sprite.frame=3;
			saladier.contenu.push('farine')
		},
		'saladier/blanc': function(farine, saladier) {
			farine.état='entamé'; farine.sprite.frame=1;
			saladier.contenu.push('farine')
		}
	},
	'sucre/plein': {
		'doseur/vide': function(sucre, doseur) {
			doseur.état='plein'; doseur.sprite.frame=1;
			doseur.contenu.push('sucreMesuré');
		},
		'saladier/propre': function(sucre, saladier) {
			saladier.état='blanc'; saladier.sprite.frame=3;
			saladier.contenu.push('sucre')
		},
		'saladier/blanc': function(sucre, saladier) {
			saladier.contenu.push('sucre')
		}
	},
	'doseur/plein': {
		'saladier/propre': function(doseur, saladier) {
			saladier.contenu=saladier.contenu.concat(doseur.contenu);
			doseur.contenu = [];
			saladier.état = 'blanc'; saladier.sprite.frame=3;
			doseur.état='vide'; doseur.sprite.frame=0;
		},
		'saladier/blanc': function(doseur, saladier) {
			saladier.contenu=saladier.contenu.concat(doseur.contenu);
			doseur.contenu = [];
			doseur.état='vide'; doseur.sprite.frame=0;
		}
	}
};

var rect = new Phaser.Rectangle( 0, 0, 800, 180 ) ;

function render() {
    game.debug.geom( rect, 'rgba(0,0,0,1)' ) ;
	
	Object.keys(objets).forEach(function(f,i) {
		game.debug.text(f+" : "+objets[f].état, 10, 20+ i * 20);
	});
	game.debug.text("doseur : "+objets["doseur"].contenu, 10, 150);
	game.debug.text("saladier : "+objets["saladier"].contenu, 10, 170);
}


function preload() {

	game.load.spritesheet('saladier', 'assets/saladier.png', 120, 60, 8);
	game.load.spritesheet('moule', 'assets/moule.png', 120, 90, 3);
	game.load.spritesheet('oeuf', 'assets/oeuf.png', 60, 60, 2);
	game.load.spritesheet('lait', 'assets/lait.png', 60, 120, 4);
	game.load.spritesheet('farine', 'assets/farine.png', 60, 90, 2);
	game.load.spritesheet('spatule', 'assets/spatule.png', 90, 60, 2);
	game.load.spritesheet('four', 'assets/four.png', 180, 180, 3);
	game.load.spritesheet('cuisson', 'assets/cuisson.png', 180, 60, 2);
	game.load.spritesheet('casserole', 'assets/casserole.png', 90, 90, 3);
	game.load.spritesheet('épices', 'assets/épices.png', 20, 40, 1);
	game.load.spritesheet('sucre', 'assets/sucre.png', 60, 90, 1);
	game.load.spritesheet('miel', 'assets/miel.png', 40, 40, 1);
	game.load.spritesheet('doseur', 'assets/verre_doseur.png', 60, 90, 2);

	game.load.image('cuisine', 'assets/scène.png');
	
}

function create() {

	//game.add.sprite(0, 0, 'cuisine');
	game.stage.backgroundColor = "#dedede";
	
	
	sprites = game.add.group();

	Object.keys(objets).forEach(function(objDataKey) {
		objData = objets[objDataKey];
		objSprite = sprites.create(objData.x, objData.y, objData.nom, 0);
		objSprite.anchor.setTo(0.5,1);
		objData.sprite = objSprite;
		game.physics.enable(objSprite, Phaser.Physics.ARCADE);
		objSprite.inputEnabled = true;
		if (objData.mobile) objSprite.input.enableDrag(true);
		//Gestion du drag&drop des objets pour les interactions entre
		//un objet et un autre.
		objSprite.events.onDragStart.add(function(obj) {
			obj.bringToTop();
			obj.retourne = function() {
				game.add.tween(obj).to(
					{ x:objets[obj.key].x, y:objets[obj.key].y},
					1000,
					Phaser.Easing.Circular.Out,
					true
				);
			}
		}, this);
		objSprite.events.onDragStop.add(function(obj) {
			game.physics.arcade.overlap(obj, sprites, function(me, other) {
				var source = me.key+"/"+objets[me.key].état;
				var cible = other.key+"/"+objets[other.key].état
				try {
					//Y'a-t-il une interaction entre ces 2 objets ?
					interactions[source][cible](objets[me.key], objets[other.key]);
				}
				catch(err) {
					console.log("Aucune interaction entre "+source+" et "+cible);
				}
			});
			//Dans tous les cas, l'objet retourne à sa (nouvelle ?) place
			obj.retourne();
		}, this);

		//Les objets qu'on ne peut pas drag&dropper peuvent
		//interagir avec eux-même...
		objSprite.events.onInputUp.add(function(obj) {
			if (!obj.input.draggable) {
				var source = obj.key+"/"+objets[obj.key].état;
				try {
					//Y-a-t-il une interaction de l'objet avec lui-même
					interactions[source]['self'](objets[obj.key]);
				} catch(err) {
					console.log("Aucune interaction de "+source+" sur lui-même");
				}
			}
		});
	});
}

</script>
</html>
